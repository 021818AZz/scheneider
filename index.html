<!doctype html>
<html lang="zh">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>Scheneider</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta name="wap-font-scale" content="no">
    <link rel="stylesheet" href="css/framework7.ios.min.css">
    <link rel="stylesheet" href="css/app.css">
    <link rel="stylesheet" href="css/iconfont.css">
    <!-- Adicionar Toastify CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style type="text/css">
        body {
            background-color: #ffffff;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            height: 100vh;
        }

        .container {
            margin: 0 auto;
        }

        .login-header {
            background: linear-gradient(51deg, #1e3a8a, #1e3a8a, #3b82f6);
            color: white;
            text-align: center;
            padding: 15px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .login-header .logo {
            height: 30px;
            object-fit: cover;
        }

        .login-header .logo img {
            height: 100%;
        }

        .login-banner {
            width: 100%;
        }

        .login-banner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .login-form {
            background-color: white;
            padding: 40px;
            border-radius: 50px 0px 0 0;
            margin-top: -50px;
            position: relative;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .input-field {
            width: 100%;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: white;
            display: flex;
            align-items: center;
        }

        .input-field input {
            border: none;
            outline: none;
            flex: 1;
            padding: 0 10px;
            font-size: 14px;
        }

        .input-field span {
            color: #3b82f6;
            margin-left: 2px;
        }

        .input-icon {
            color: #3b82f6;
            width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-icon img {
            width: 24px;
            height: 24px;
        }

        .login-button {
            width: 100%;
            background: linear-gradient(51deg, #1e3a8a, #1e3a8a, #3b82f6);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .login-button:disabled {
            background: linear-gradient(51deg, #6b7280, #6b7280, #9ca3af) !important;
            cursor: not-allowed;
        }

        .bottom-links {
            display: flex;
            justify-content: right;
            margin-top: 15px;
        }

        .bottom-links a {
            color: #3b82f6;
            text-decoration: none;
        }

        .loginfield {
            padding-top: 10px;
        }

        /* Estilo para o código de área clicável */
        .area-code-selector {
            cursor: pointer;
            user-select: none;
        }

        /* Cores personalizadas para os toasts */
        .toast-success {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6) !important;
        }

        .toast-error {
            background: linear-gradient(135deg, #6a8fe0, #1fa9e3) !important;
        }

        .toast-info {
            background: linear-gradient(135deg, #a0a0a0, #708090) !important;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
        }
    </style>
</head>

<body>

<div class="container">
    <div class="login-header">
        <div class="logo">
            <img src="img/LG1.png++.png" alt="Logo">
        </div>
    </div>
    <div class="login-banner">
        <img src="img/login.jpg" alt="Banner">
    </div>
   <div class="login-form">
    <form name="form" method="post" id="form">
        <div class="form-group">
            <label>Número de Telefone</label>
            <div class="input-field">
                <div class="input-icon">
                    <img src="img/telefone.png" alt="Telefone">
                </div>
                <span class="area-code-selector" id="area_code" onclick="quhao_select()">244</span>
                <input type="text" id="mobile" name="mobile" placeholder="Por favor, insira seu número de telefone" minlength="7" maxlength="9">
            </div>
        </div>
        <div class="form-group">
            <label>Senha</label>
            <div class="input-field">
                <div class="input-icon">
                    <img src="img/senha.png" alt="Senha">
                </div>
                <input type="password" id="password" name="password" placeholder="Por favor, insira sua senha" maxlength="16">
            </div>
        </div>
        <div class="row loginfield">
            <div style="display: inline-block;">
                <input type="checkbox" id="remember_password">
                Lembrar senha
            </div>
        </div>
        <button type="button" class="login-button btn_submit_my">Entrar</button>
    </form>
    <div class="bottom-links">
        <a href="/register.html">Criar uma conta</a>
    </div>
</div>
</div>

<!-- Loading overlay (inicialmente oculto) -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div>Carregando...</div>
</div>

<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="js/layer.js"></script>
<!-- Adicionar Toastify JS -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script type="text/javascript">
    // Configuração da API
    const API_BASE_URL = 'https://bd-p4q7.onrender.com';
    const TOKEN_EXPIRY_HOURS = 5;

    // Função para mostrar toast
    function showToast(message, type = 'info') {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "center",
            stopOnFocus: true,
            className: type === 'error' ? 'toast-error' : 
                      type === 'success' ? 'toast-success' : 'toast-info',
            style: {
                width: "100%",
                left: "0",
                right: "0",
                borderRadius: "0",
                textAlign: "center",
                padding: "15px",
                fontSize: "14px",
                fontWeight: "bold"
            }
        }).showToast();
    }

    // Função para mostrar/ocultar loading
    function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        $('.btn_submit_my').prop('disabled', true);
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
        $('.btn_submit_my').prop('disabled', false);
    }

    // Função para resetar o estado do botão
    function resetSubmitState() {
        window._submit = true;
        $('.btn_submit_my').prop('disabled', false);
    }

    // Função para seleção de código de área (apenas Angola)
    function quhao_select() {
        layer.open({
            type: 1,
            content: '<div style="padding:0 10px;background-color: #f8f9fa;"><div style="height:200px;overflow-y:scroll;"><div class="guojia-list-item" onclick="qhselect(244)" style="padding: 15px; border-bottom: 1px solid #eee; cursor: pointer;">244 Angola</div></div></div>',
            anim: 'up',
            style: 'position:fixed; bottom:0; left:0; width: 100%; height: 200px; padding:10px 0; border:none; background-color: #f8f9fa;'
        });
    }

    function qhselect(quhao) {
        $("#area_code").html(quhao);
        layer.closeAll();
    }

    // Função para validar número de telefone
    function checkMobile(mobile) {
        const reg = /^\d{9,9}$/; // 9 dígitos para Angola
        return reg.test(mobile);
    }

    // Função para verificar se deve lembrar usuário
    function checkRememberMe() {
        const rememberMe = localStorage.getItem('rememberMe');
        const savedMobile = localStorage.getItem('user_mobile');
        
        if (rememberMe === 'true' && savedMobile) {
            // Extrair apenas a parte do número (sem código do país)
            const numberOnly = savedMobile.replace(/^\d+/, '');
            $("#mobile").val(numberOnly);
            $("#remember_password").prop('checked', true);
        }
    }

    // Função para salvar preferência de lembrar senha
    function saveRememberPreference() {
        const rememberCheckbox = document.getElementById('remember_password');
        const areaCode = $("#area_code").html();
        const userMobile = $("#mobile").val();
        
        if (rememberCheckbox.checked && userMobile) {
            localStorage.setItem('rememberMe', 'true');
            localStorage.setItem('user_mobile', areaCode + userMobile);
        } else {
            localStorage.setItem('rememberMe', 'false');
            localStorage.removeItem('user_mobile');
        }
    }

    // Função para verificar se o token no localStorage ainda é válido
    function isTokenValid() {
        const tokenData = localStorage.getItem('user_token');
        
        if (!tokenData) return false;
        
        try {
            const { token, expiry } = JSON.parse(tokenData);
            
            // Verificar se o token expirou
            if (Date.now() > expiry) {
                // Token expirado, remover do localStorage
                localStorage.removeItem('user_token');
                localStorage.removeItem('user_id');
                return false;
            }
            
            return true;
        } catch (e) {
            console.error('Erro ao verificar token:', e);
            return false;
        }
    }

    // Função principal de login
    async function performLogin(mobile, password) {
        const areaCode = $("#area_code").html();
        const fullMobile = areaCode + mobile;
        
        // Salvar preferência de lembrar senha
        saveRememberPreference();

        try {
            // Fazer requisição para a API de login
            const response = await fetch(`${API_BASE_URL}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    mobile: fullMobile,
                    password: password
                })
            });

            const data = await response.json();

            if (data.success) {
                // Login bem-sucedido - Armazenar no localStorage com expiração
                const tokenData = {
                    token: data.data.token,
                    expiry: Date.now() + (TOKEN_EXPIRY_HOURS * 60 * 60 * 1000) // 5 horas a partir de agora
                };
                
                // Salvar no localStorage
                localStorage.setItem('user_token', JSON.stringify(tokenData));
                localStorage.setItem('user_id', data.data.user.id);
                
                hideLoading();
                showToast('Login realizado com sucesso!', 'success');
                
                // Redirecionar após um breve delay
                setTimeout(() => {
                    window.location.href = '/indice.html';
                }, 1500);
            } else {
                hideLoading();
                showToast(data.message || 'Erro ao fazer login', 'error');
                resetSubmitState();
            }
        } catch (error) {
            console.error('Erro no login:', error);
            hideLoading();
            showToast('Erro de conexão com o servidor', 'error');
            resetSubmitState();
        }
    }

    // Código principal quando o documento estiver pronto
    $(document).ready(function() {
        // Verificar lembrar senha
        checkRememberMe();
        
        // Verificar se há token válido no localStorage
        if (isTokenValid()) {
            // Se já tem token válido, redirecionar para dashboard
            window.location.href = '/indice.html';
        }

        // Inicializar variável global
        window._submit = true;
        
        $(".btn_submit_my").click(function () {
            if (!window._submit) {
                console.log('Submit bloqueado, aguardando...');
                return false;
            }
            
            window._submit = false;
            showLoading();
            
            var mobile = $.trim($("#mobile").val());
            var password = $("#password").val();
            
            console.log('Validando login:', { mobile, password: '***' });

            // Validações
            if (!mobile) {
                hideLoading();
                showToast('Digite o número de celular...', 'error');
                resetSubmitState();
                return false;
            }

            if (!checkMobile(mobile)) {
                hideLoading();
                showToast('O número de telefone deve ter exatamente 9 dígitos.', 'error');
                resetSubmitState();
                return false;
            }
            
            if (!password) {
                hideLoading();
                showToast('Digite a senha...', 'error');
                resetSubmitState();
                return false;
            }

            if (password.length < 6) {
                hideLoading();
                showToast('A senha deve ter pelo menos 6 caracteres', 'error');
                resetSubmitState();
                return false;
            }

            console.log('Chamando API de login...');
            // Chamar função de login com API
            performLogin(mobile, password);
        });

        // Tecla Enter para submeter o formulário
        $("#password").keypress(function(e) {
            if (e.which === 13) {
                $(".btn_submit_my").click();
            }
        });

        // Resetar estado se o usuário mudar algum campo
        $("input").on('input', function() {
            resetSubmitState();
        });
    });

    // Funções auxiliares para cookies (mantidas para compatibilidade)
    function setCookie(name, value, days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + date.toUTCString() + ';path=/';
    }

    function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return decodeURIComponent(c.substring(nameEQ.length,c.length));
        }
        return null;
    }

    function clearAllCookie() {
        var cookies = document.cookie.split(";");
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i];
            var eqPos = cookie.indexOf("=");
            var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
        }
    }
</script>
</body>
</html>